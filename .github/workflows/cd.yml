name: CD

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: false
        type: choice
        options:
          - patch
          - minor
          - major
        default: 'patch'

permissions:
  contents: write

jobs:
  # =============================================================================
  # macOS Builds
  # =============================================================================
  build-macos:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-15
            arch: arm64
            js_engine: quickjs
            webgpu: wgpu
            name: macOS-arm64-quickjs-wgpu
          - os: macos-15
            arch: arm64
            js_engine: v8
            webgpu: wgpu
            name: macOS-arm64-v8-wgpu
          - os: macos-15
            arch: arm64
            js_engine: jsc
            webgpu: wgpu
            name: macOS-arm64-jsc-wgpu
          - os: macos-15
            arch: arm64
            js_engine: quickjs
            webgpu: dawn
            name: macOS-arm64-quickjs-dawn
          - os: macos-15
            arch: arm64
            js_engine: v8
            webgpu: dawn
            name: macOS-arm64-v8-dawn
          - os: macos-15
            arch: arm64
            js_engine: jsc
            webgpu: dawn
            name: macOS-arm64-jsc-dawn
          - os: macos-15-intel
            arch: x64
            js_engine: jsc
            webgpu: dawn
            name: macOS-x64-jsc-dawn

    name: Build - ${{ matrix.name }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache dependencies
        uses: actions/cache@v4
        id: cache-deps
        with:
          path: third_party
          key: deps-macos-${{ matrix.arch }}-${{ matrix.webgpu }}-${{ hashFiles('scripts/download-deps.mjs') }}

      - name: Download base dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: node scripts/download-deps.mjs

      - name: Download V8 (if needed)
        if: matrix.js_engine == 'v8' && steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          brew install p7zip || true
          node scripts/download-deps.mjs --only v8

      - name: Download Dawn (if needed)
        if: matrix.webgpu == 'dawn' && steps.cache-deps.outputs.cache-hit != 'true'
        run: node scripts/download-deps.mjs --only dawn

      - name: Configure CMake
        run: |
          CMAKE_ARGS="-B build -DCMAKE_BUILD_TYPE=Release"
          if [ "${{ matrix.js_engine }}" == "quickjs" ]; then
            CMAKE_ARGS="$CMAKE_ARGS -DMYSTRAL_USE_QUICKJS=ON -DMYSTRAL_USE_V8=OFF -DMYSTRAL_USE_JSC=OFF"
          elif [ "${{ matrix.js_engine }}" == "v8" ]; then
            CMAKE_ARGS="$CMAKE_ARGS -DMYSTRAL_USE_QUICKJS=OFF -DMYSTRAL_USE_V8=ON -DMYSTRAL_USE_JSC=OFF"
          elif [ "${{ matrix.js_engine }}" == "jsc" ]; then
            CMAKE_ARGS="$CMAKE_ARGS -DMYSTRAL_USE_QUICKJS=OFF -DMYSTRAL_USE_V8=OFF -DMYSTRAL_USE_JSC=ON"
          fi
          if [ "${{ matrix.webgpu }}" == "wgpu" ]; then
            CMAKE_ARGS="$CMAKE_ARGS -DMYSTRAL_USE_WGPU=ON -DMYSTRAL_USE_DAWN=OFF"
          elif [ "${{ matrix.webgpu }}" == "dawn" ]; then
            CMAKE_ARGS="$CMAKE_ARGS -DMYSTRAL_USE_WGPU=OFF -DMYSTRAL_USE_DAWN=ON"
          fi
          cmake $CMAKE_ARGS

      - name: Build
        run: cmake --build build --config Release -j$(sysctl -n hw.ncpu)

      - name: Test CLI
        run: ./build/mystral --version

      - name: Verify static linking
        run: |
          echo "Binary linkage (should NOT show SDL3 as dynamic dependency):"
          otool -L build/mystral | head -20

      - name: Package artifacts
        run: |
          mkdir -p artifacts
          # Single static binary - no SDL3 framework needed
          cp build/mystral artifacts/
          cp build/libmystral-runtime.a artifacts/ || true
          # Include examples so users can try them immediately
          mkdir -p artifacts/examples/assets
          cp examples/triangle.js artifacts/examples/
          cp examples/simple-cube.js artifacts/examples/
          cp examples/test-audio.js artifacts/examples/
          cp examples/test-gamepad.js artifacts/examples/
          cp examples/mystral-helmet.js artifacts/examples/ || true
          cp examples/assets/DamagedHelmet.glb artifacts/examples/assets/ || true
          cp examples/assets/environment.hdr artifacts/examples/assets/ || true
          cd artifacts && zip -r ../mystral-${{ matrix.name }}.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mystral-${{ matrix.name }}
          path: mystral-${{ matrix.name }}.zip

  # =============================================================================
  # Linux Builds
  # =============================================================================
  build-linux:
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        include:
          - js_engine: quickjs
            webgpu: wgpu
            name: linux-x64-quickjs-wgpu
          - js_engine: v8
            webgpu: wgpu
            name: linux-x64-v8-wgpu
          - js_engine: quickjs
            webgpu: dawn
            name: linux-x64-quickjs-dawn
          - js_engine: v8
            webgpu: dawn
            name: linux-x64-v8-dawn

    name: Build - ${{ matrix.name }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake build-essential \
            libx11-dev libxext-dev libxrandr-dev libxi-dev libxinerama-dev libxcursor-dev \
            libwayland-dev libxkbcommon-dev libegl-dev libgles-dev \
            libcurl4-openssl-dev zlib1g-dev libfontconfig1-dev p7zip-full

      - name: Cache dependencies
        uses: actions/cache@v4
        id: cache-deps
        with:
          path: third_party
          key: deps-linux-x64-${{ matrix.webgpu }}-v5-${{ hashFiles('scripts/download-deps.mjs') }}

      - name: Download base dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: node scripts/download-deps.mjs

      - name: Download V8 (if needed)
        if: matrix.js_engine == 'v8' && steps.cache-deps.outputs.cache-hit != 'true'
        run: node scripts/download-deps.mjs --only v8

      - name: Download Dawn (if needed)
        if: matrix.webgpu == 'dawn' && steps.cache-deps.outputs.cache-hit != 'true'
        run: node scripts/download-deps.mjs --only dawn

      - name: Configure CMake
        run: |
          # SDL3 is built from source via add_subdirectory (static linking)
          CMAKE_ARGS="-B build -DCMAKE_BUILD_TYPE=Release"
          if [ "${{ matrix.js_engine }}" == "quickjs" ]; then
            CMAKE_ARGS="$CMAKE_ARGS -DMYSTRAL_USE_QUICKJS=ON -DMYSTRAL_USE_V8=OFF -DMYSTRAL_USE_JSC=OFF"
          elif [ "${{ matrix.js_engine }}" == "v8" ]; then
            CMAKE_ARGS="$CMAKE_ARGS -DMYSTRAL_USE_QUICKJS=OFF -DMYSTRAL_USE_V8=ON -DMYSTRAL_USE_JSC=OFF"
          fi
          if [ "${{ matrix.webgpu }}" == "wgpu" ]; then
            CMAKE_ARGS="$CMAKE_ARGS -DMYSTRAL_USE_WGPU=ON -DMYSTRAL_USE_DAWN=OFF"
          elif [ "${{ matrix.webgpu }}" == "dawn" ]; then
            CMAKE_ARGS="$CMAKE_ARGS -DMYSTRAL_USE_WGPU=OFF -DMYSTRAL_USE_DAWN=ON"
          fi
          cmake $CMAKE_ARGS

      - name: Build
        run: cmake --build build --config Release -j$(nproc)

      - name: Test CLI
        run: ./build/mystral --version

      - name: Verify static linking
        run: |
          echo "Binary linkage (should NOT show libSDL3.so as dynamic dependency):"
          ldd build/mystral | head -20 || true

      - name: Package artifacts
        run: |
          mkdir -p artifacts
          # Single static binary - no SDL3 shared library needed
          cp build/mystral artifacts/
          cp build/libmystral-runtime.a artifacts/ || true
          # Include examples so users can try them immediately
          mkdir -p artifacts/examples/assets
          cp examples/triangle.js artifacts/examples/
          cp examples/simple-cube.js artifacts/examples/
          cp examples/test-audio.js artifacts/examples/
          cp examples/test-gamepad.js artifacts/examples/
          cp examples/mystral-helmet.js artifacts/examples/ || true
          cp examples/assets/DamagedHelmet.glb artifacts/examples/assets/ || true
          cp examples/assets/environment.hdr artifacts/examples/assets/ || true
          cd artifacts && zip -r ../mystral-${{ matrix.name }}.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mystral-${{ matrix.name }}
          path: mystral-${{ matrix.name }}.zip

  # =============================================================================
  # Windows Builds - wgpu
  # =============================================================================
  build-windows-wgpu:
    runs-on: windows-2022
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        include:
          - js_engine: quickjs
            name: windows-x64-quickjs-wgpu
          - js_engine: v8
            name: windows-x64-v8-wgpu

    name: Build - ${{ matrix.name }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache dependencies
        uses: actions/cache@v4
        id: cache-deps
        with:
          path: third_party
          key: deps-windows-x64-wgpu-v10-${{ hashFiles('scripts/download-deps.mjs') }}

      - name: Download base dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        shell: bash
        run: |
          export PATH="/c/Program Files/7-Zip:$PATH"
          node scripts/download-deps.mjs

      - name: Download V8 (if needed)
        if: matrix.js_engine == 'v8' && steps.cache-deps.outputs.cache-hit != 'true'
        shell: bash
        run: |
          export PATH="/c/Program Files/7-Zip:$PATH"
          node scripts/download-deps.mjs --only v8

      - name: Install vcpkg dependencies
        run: |
          vcpkg install curl:x64-windows-static zlib:x64-windows-static
          vcpkg integrate install

      - name: Configure CMake
        run: |
          $CMAKE_ARGS = @("-B", "build", "-DCMAKE_BUILD_TYPE=Release")
          if ("${{ matrix.js_engine }}" -eq "quickjs") {
            $CMAKE_ARGS += "-DMYSTRAL_USE_QUICKJS=ON", "-DMYSTRAL_USE_V8=OFF", "-DMYSTRAL_USE_JSC=OFF"
          } elseif ("${{ matrix.js_engine }}" -eq "v8") {
            $CMAKE_ARGS += "-DMYSTRAL_USE_QUICKJS=OFF", "-DMYSTRAL_USE_V8=ON", "-DMYSTRAL_USE_JSC=OFF"
            # V8 requires C++20
            $CMAKE_ARGS += "-DCMAKE_CXX_STANDARD=20"
          }
          $CMAKE_ARGS += "-DMYSTRAL_USE_WGPU=ON", "-DMYSTRAL_USE_DAWN=OFF"
          $CMAKE_ARGS += "-DVCPKG_TARGET_TRIPLET=x64-windows-static"
          $CMAKE_ARGS += "-DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded"
          $CMAKE_ARGS += "-DCMAKE_TOOLCHAIN_FILE=$env:VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake"
          cmake @CMAKE_ARGS

      - name: Build
        run: cmake --build build --config Release

      - name: Test CLI
        shell: bash
        run: ./build/Release/mystral.exe --version || echo "Build complete"

      - name: Package artifacts
        shell: bash
        run: |
          mkdir -p artifacts
          # Single static binary - no SDL3.dll needed
          cp build/Release/mystral.exe artifacts/ || cp build/mystral.exe artifacts/
          cp build/Release/mystral-runtime.lib artifacts/ || cp build/mystral-runtime.lib artifacts/ || true
          # Include examples so users can try them immediately
          mkdir -p artifacts/examples/assets
          cp examples/triangle.js artifacts/examples/
          cp examples/simple-cube.js artifacts/examples/
          cp examples/test-audio.js artifacts/examples/
          cp examples/test-gamepad.js artifacts/examples/
          cp examples/mystral-helmet.js artifacts/examples/ || true
          cp examples/assets/DamagedHelmet.glb artifacts/examples/assets/ || true
          cp examples/assets/environment.hdr artifacts/examples/assets/ || true
          cd artifacts && 7z a ../mystral-${{ matrix.name }}.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mystral-${{ matrix.name }}
          path: mystral-${{ matrix.name }}.zip

  # =============================================================================
  # Windows Builds - Dawn
  # =============================================================================
  build-windows-dawn:
    runs-on: windows-2022
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        include:
          - js_engine: quickjs
            name: windows-x64-quickjs-dawn
          - js_engine: v8
            name: windows-x64-v8-dawn

    name: Build - ${{ matrix.name }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache dependencies
        uses: actions/cache@v4
        id: cache-deps
        with:
          path: third_party
          key: deps-windows-x64-dawn-v13-${{ hashFiles('scripts/download-deps.mjs') }}

      - name: Download base dependencies (excluding Skia/Dawn - use library-builder version)
        if: steps.cache-deps.outputs.cache-hit != 'true'
        shell: bash
        run: |
          export PATH="/c/Program Files/7-Zip:$PATH"
          # Exclude skia and dawn - we'll use skia-win-static from library-builder instead
          # which includes both Skia and Dawn with matching /MT static CRT
          node scripts/download-deps.mjs --exclude skia,dawn

      - name: Download V8 (if needed)
        if: matrix.js_engine == 'v8' && steps.cache-deps.outputs.cache-hit != 'true'
        shell: bash
        run: |
          export PATH="/c/Program Files/7-Zip:$PATH"
          node scripts/download-deps.mjs --only v8

      - name: Download Skia with Dawn for Windows builds
        if: steps.cache-deps.outputs.cache-hit != 'true'
        shell: bash
        run: |
          export PATH="/c/Program Files/7-Zip:$PATH"
          # Download Skia + Dawn from library-builder (includes dawn_combined.lib with D3D11/D3D12)
          # This build uses /MT static CRT and has full WebGPU implementation
          node scripts/download-deps.mjs --only skia-win-static

      - name: Create WebGPU wrapper headers
        # Always run this - wrapper headers are not in the cache, only downloaded deps
        shell: bash
        run: |
          # library-builder Skia only has dawn/*.h headers, but code expects webgpu/*.h
          # Create wrapper headers that include the dawn versions
          INCLUDE_DIR="third_party/skia/build/include"
          mkdir -p "$INCLUDE_DIR/webgpu"

          # webgpu/webgpu.h -> dawn/webgpu.h
          # Use angle brackets so it searches include paths (dawn/ is a sibling dir, not subdir)
          printf '#ifndef INCLUDE_WEBGPU_WEBGPU_H_\n#define INCLUDE_WEBGPU_WEBGPU_H_\n#include <dawn/webgpu.h>\n#endif\n' > "$INCLUDE_DIR/webgpu/webgpu.h"

          # webgpu/webgpu_cpp.h -> dawn/webgpu_cpp.h
          printf '#ifndef INCLUDE_WEBGPU_WEBGPU_CPP_H_\n#define INCLUDE_WEBGPU_WEBGPU_CPP_H_\n#include <dawn/webgpu_cpp.h>\n#endif\n' > "$INCLUDE_DIR/webgpu/webgpu_cpp.h"

          echo "Created WebGPU wrapper headers in $INCLUDE_DIR/webgpu/"
          cat "$INCLUDE_DIR/webgpu/webgpu.h"
          ls -la "$INCLUDE_DIR/webgpu/"

      - name: Install vcpkg dependencies
        run: |
          vcpkg install curl:x64-windows-static zlib:x64-windows-static
          vcpkg integrate install

      - name: Configure CMake
        run: |
          $CMAKE_ARGS = @("-B", "build", "-DCMAKE_BUILD_TYPE=Release")
          if ("${{ matrix.js_engine }}" -eq "quickjs") {
            $CMAKE_ARGS += "-DMYSTRAL_USE_QUICKJS=ON", "-DMYSTRAL_USE_V8=OFF", "-DMYSTRAL_USE_JSC=OFF"
          } elseif ("${{ matrix.js_engine }}" -eq "v8") {
            $CMAKE_ARGS += "-DMYSTRAL_USE_QUICKJS=OFF", "-DMYSTRAL_USE_V8=ON", "-DMYSTRAL_USE_JSC=OFF"
            # V8 requires C++20
            $CMAKE_ARGS += "-DCMAKE_CXX_STANDARD=20"
          }
          $CMAKE_ARGS += "-DMYSTRAL_USE_WGPU=OFF", "-DMYSTRAL_USE_DAWN=ON"
          $CMAKE_ARGS += "-DVCPKG_TARGET_TRIPLET=x64-windows-static"
          $CMAKE_ARGS += "-DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded"
          $CMAKE_ARGS += "-DCMAKE_TOOLCHAIN_FILE=$env:VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake"
          cmake @CMAKE_ARGS

      - name: Build
        run: cmake --build build --config Release

      - name: Test CLI
        shell: bash
        run: ./build/Release/mystral.exe --version || echo "Build complete"

      - name: Package artifacts
        shell: bash
        run: |
          mkdir -p artifacts
          # Single static binary - no SDL3.dll needed
          cp build/Release/mystral.exe artifacts/ || cp build/mystral.exe artifacts/
          cp build/Release/mystral-runtime.lib artifacts/ || cp build/mystral-runtime.lib artifacts/ || true
          # Include examples so users can try them immediately
          mkdir -p artifacts/examples/assets
          cp examples/triangle.js artifacts/examples/
          cp examples/simple-cube.js artifacts/examples/
          cp examples/test-audio.js artifacts/examples/
          cp examples/test-gamepad.js artifacts/examples/
          cp examples/mystral-helmet.js artifacts/examples/ || true
          cp examples/assets/DamagedHelmet.glb artifacts/examples/assets/ || true
          cp examples/assets/environment.hdr artifacts/examples/assets/ || true
          cd artifacts && 7z a ../mystral-${{ matrix.name }}.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mystral-${{ matrix.name }}
          path: mystral-${{ matrix.name }}.zip

  # =============================================================================
  # Create Release
  # =============================================================================
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-macos, build-linux, build-windows-wgpu, build-windows-dawn]
    if: success()

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current version from package.json
        id: current_version
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      - name: Get next version
        id: next_version
        run: |
          CURRENT="${{ steps.current_version.outputs.version }}"
          BUMP="${{ inputs.version_bump }}"

          # Parse version components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          # Check if this is the initial release (0.0.1)
          if [ "$CURRENT" == "0.0.1" ]; then
            # First release - use 0.0.1 as is
            NEXT="0.0.1"
          else
            # Increment based on bump type
            case "$BUMP" in
              major)
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                ;;
              minor)
                MINOR=$((MINOR + 1))
                PATCH=0
                ;;
              patch)
                PATCH=$((PATCH + 1))
                ;;
            esac
            NEXT="${MAJOR}.${MINOR}.${PATCH}"
          fi

          echo "next=$NEXT" >> $GITHUB_OUTPUT
          echo "Next version: $NEXT"

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update version in package.json (if not initial release)
        if: steps.current_version.outputs.version != '0.0.1' || steps.next_version.outputs.next == '0.0.1'
        run: |
          NEXT="${{ steps.next_version.outputs.next }}"
          CURRENT="${{ steps.current_version.outputs.version }}"

          # Only update if version changed
          if [ "$NEXT" != "$CURRENT" ]; then
            jq --arg v "$NEXT" '.version = $v' package.json > temp.json && mv temp.json package.json
            git add package.json
            git commit -m "Bump version to $NEXT"
            git push origin main
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          for dir in artifacts/mystral-*; do
            if [ -d "$dir" ]; then
              name=$(basename "$dir")
              # The artifact contains a zip, move it to release-assets
              cp "$dir"/*.zip release-assets/ || true
            fi
          done
          ls -la release-assets/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.next_version.outputs.next }}
          name: MystralNative v${{ steps.next_version.outputs.next }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            release-assets/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update package.json for next development cycle
        if: steps.current_version.outputs.version == '0.0.1'
        run: |
          # After initial 0.0.1 release, bump to 0.0.2 for next release
          jq '.version = "0.0.2"' package.json > temp.json && mv temp.json package.json
          git add package.json
          git commit -m "Prepare for next development iteration (0.0.2)"
          git push origin main
